<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>止め処なき我々の意志！</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }
    #chat {
      height: 300px;
      overflow-y: auto;
      border: 1px solid gray;
      padding: 10px;
      margin-bottom: 10px;
      background: #222;
    }
    .message {
      border: 2px solid #4caf50;
      border-radius: 10px;
      padding: 8px;
      margin: 5px 0;
      background: #333;
      color: white;
    }
    .own {
      border-color: #4caf50;
      background: #333;
      color: white;
    }
    .timestamp {
      font-size: 0.75em;
      color: #ccc;
      margin-top: 4px;
    }
    textarea {
      width: 100%;
      height: 60px;
      padding: 8px;
      font-size: 1em;
      border-radius: 5px;
      border: none;
      resize: vertical;
      background: #222;
      color: white;
    }
    button {
      margin-top: 5px;
      padding: 8px 16px;
      font-size: 1em;
      background: #4caf50;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      initializeAppCheck, ReCaptchaV3Provider
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app-check.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmBCpv6Zk5uF5hUxkZz7oCmPyttlJJTm8",
      authDomain: "test-3c7db.firebaseapp.com",
      projectId: "test-3c7db",
      storageBucket: "test-3c7db.appspot.com",
      messagingSenderId: "1053400767865",
      appId: "1:1053400767865:web:a2b9674a03843da87863a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider("6LcoVYgrAAAAAEO2x4QeIQdS_-P-1YZEiFEqmm3N"),
      isTokenAutoRefreshEnabled: true
    });

    let currentUID = null;
    let lastSendTime = 0;

    function generateNickname(uid) {
      if (!uid) return "anon000";
      const safeUid = uid.replace(/[^a-zA-Z0-9]/g, "");
      return "anon" + safeUid.slice(-3);
    }

    signInAnonymously(auth).catch((error) => {
      console.error("匿名ログイン失敗:", error.code, error.message);
    });

    function escapeHTML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUID = user.uid;
        const nickname = generateNickname(currentUID);
        console.log("ログイン成功: UID =", currentUID, "nickname =", nickname);

        window.sendMessage = async function () {
          const now = Date.now();
          if (now - lastSendTime < 5000) {
            alert("5秒お待ちください！");
            return;
          }

          const text = document.getElementById("message").value.trim();
          if (!text) return;

          const nickname = generateNickname(currentUID);
          if (!/^[a-zA-Z0-9_\-]{1,50}$/.test(nickname)) {
            alert("ニックネームが不正です: " + nickname);
            return;
          }

          try {
            await addDoc(collection(db, "messages"), {
              text: text,
              uid: String(currentUID),
              nickname: nickname,
              created: serverTimestamp()
            });

            document.getElementById("message").value = "";
            lastSendTime = now;
          } catch (err) {
            alert("送信に失敗しました: " + err.message);
            console.error(err);
          }
        };

        const q = query(collection(db, "messages"), orderBy("created"));
        onSnapshot(q, (snapshot) => {
          const chat = document.getElementById("chat");
          chat.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "message";
            if (data.uid === currentUID) {
              div.classList.add("own");
            }

            div.onclick = () => {
              const quote = `>> ${data.nickname || generateNickname(data.uid)}: ${data.text}`;
              document.getElementById("message").value = quote;
            };

            const name = document.createElement("div");
            name.className = "nickname";
            name.textContent = data.nickname || generateNickname(data.uid);
            div.appendChild(name);

            const msgText = document.createElement("div");
            msgText.innerHTML = escapeHTML(data.text || "").replace(/\n/g, "<br>");
            div.appendChild(msgText);

            if (data.created?.toDate) {
              const ts = document.createElement("div");
              ts.className = "timestamp";
              ts.textContent = new Date(data.created.toDate()).toLocaleString();
              div.appendChild(ts);
            }

            chat.appendChild(div);
          });
        });
      } else {
        console.warn("ユーザーがログアウトしています");
      }
    });
  </script>
</head>
<body>
  <h1>
    <img src="FRISK MAN.png" alt="FRISK MAN" style="height: 40px; vertical-align: middle; margin-right: 10px;">
    止め処なき我々の意志！
  </h1>
  <div id="chat"></div>
  <textarea id="message" placeholder="メッセージを入力（複数行可）"></textarea><br />
  <button onclick="sendMessage()">送信</button>
</body>
</html>
